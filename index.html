import React, { useMemo, useState, useEffect } from "react";

// v2 (fix): fermeture balises OK, fonction Field unique, Teams <> Recap corrigé
// Wireframe propre et fonctionnel (aucun style final)
// Flux : Home → Catégories → Déposant → Responsables → Récap → Paiement → Confirmation
// Règles : 6 catégories, 30 équipes max/catégorie, max 2 équipes par club et par catégorie

const CATEGORIES = [
  { id: "G", label: "G" },
  { id: "F", label: "F" },
  { id: "E", label: "E" },
  { id: "D", label: "D" },
  { id: "FE11", label: "FE11" },
  { id: "FE14", label: "FE14" },
];

const INITIAL_SLOTS = Object.fromEntries(CATEGORIES.map((c) => [c.id, 30]));

export default function App() {
  const [page, setPage] = useState("home");
  const [eventDate] = useState("2026-06-21T09:00:00");
  const [slotsLeft, setSlotsLeft] = useState(INITIAL_SLOTS);
  const [selection, setSelection] = useState({}); // { FE11: 2, F: 1, ... }
  const [deposant, setDeposant] = useState({ prenom: "", nom: "", email: "", telephone: "", club: "" });
  const [teams, setTeams] = useState([]); // [{category, idx, nomEquipe, prenom, nom, telephone, email}]

  const totalTeams = useMemo(() => teams.length, [teams]);

  const go = (next) => setPage(next);
  const resetFlow = () => {
    setSelection({});
    setDeposant({ prenom: "", nom: "", email: "", telephone: "", club: "" });
    setTeams([]);
  };

  return (
    <div className="min-h-screen bg-neutral-100 text-neutral-900">
      <Header onHome={() => setPage("home")} />
      <main className="max-w-6xl mx-auto p-4 sm:p-6">
        {page === "home" && (
          <Home
            eventDate={eventDate}
            slotsLeft={slotsLeft}
            onInscrire={() => go("categories")}
          />
        )}

        {page === "categories" && (
          <Categories
            slotsLeft={slotsLeft}
            selection={selection}
            onChangeSelection={(catId, val) => {
              const safe = Math.max(0, Math.min(2, Number(val || 0)));
              setSelection((prev) => ({ ...prev, [catId]: safe }));
            }}
            onNext={() => {
              const arr = [];
              Object.entries(selection).forEach(([cat, n]) => {
                for (let i = 1; i <= (n || 0); i++) {
                  arr.push({ category: cat, idx: i, nomEquipe: "", prenom: "", nom: "", telephone: "", email: "" });
                }
              });
              setTeams(arr);
              go("deposant");
            }}
            onBack={() => go("home")}
          />
        )}

        {page === "deposant" && (
          <Deposant
            data={deposant}
            onChange={setDeposant}
            onNext={() => go("teams")}
            onBack={() => go("categories")}
          />
        )}

        {page === "teams" && (
          <Teams
            teams={teams}
            onChangeTeam={(i, t) => setTeams((prev) => prev.map((x, idx) => (idx === i ? t : x)))}
            onNext={() => go("recap")}
            onBack={() => go("deposant")}
          />
        )}

        {page === "recap" && (
          <Recap
            deposant={deposant}
            teams={teams}
            selection={selection}
            slotsLeft={slotsLeft}
            onBack={() => go("teams")}
            onPay={() => go("paiement")}
          />
        )}

        {page === "paiement" && (
          <Paiement
            totalTeams={totalTeams}
            onBack={() => go("recap")}
            onPaid={() => {
              const updated = { ...slotsLeft };
              Object.entries(selection).forEach(([cat, n]) => {
                if (!n) return;
                updated[cat] = Math.max(0, (updated[cat] || 0) - n);
              });
              setSlotsLeft(updated);
              go("confirmation");
            }}
          />
        )}

        {page === "confirmation" && (
          <Confirmation deposant={deposant} teams={teams} onNouveau={() => { resetFlow(); go("home"); }} />
        )}
      </main>
      <Footer />
    </div>
  );
}

function Header({ onHome }) {
  return (
    <header className="border-b border-neutral-300 bg-white">
      <div className="max-w-6xl mx-auto p-4 flex items-center justify-between">
        <button onClick={onHome} className="text-lg font-semibold hover:underline">Tournoi Régional – Foot (Wireframe)</button>
        <nav className="flex gap-4 text-sm">
          <a className="hover:underline" href="#" onClick={(e) => e.preventDefault()}>Infos</a>
          <a className="hover:underline" href="#" onClick={(e) => e.preventDefault()}>Règlement</a>
          <a className="hover:underline" href="#" onClick={(e) => e.preventDefault()}>Contact</a>
        </nav>
      </div>
    </header>
  );
}

function Home({ eventDate, slotsLeft, onInscrire }) {
  const totalRegistered = useMemo(() => {
    const capacity = Object.values(INITIAL_SLOTS).reduce((a, b) => a + b, 0);
    const remaining = Object.values(slotsLeft).reduce((a, b) => a + b, 0);
    return capacity - remaining;
  }, [slotsLeft]);

  return (
    <section>
      {/* Header visuel en 2 colonnes : Photo + Décompte */}
      <div className="grid md:grid-cols-2 gap-4 md:gap-8 items-stretch">
        <div className="bg-neutral-300 h-64 md:h-80 rounded-lg flex items-center justify-center">
          <span className="text-neutral-700">PHOTO / HERO</span>
        </div>
        <div className="bg-white rounded-lg p-4 md:p-6 border border-neutral-300 flex flex-col gap-4">
          <h1 className="text-2xl font-semibold">Tournoi Régional – Inscriptions</h1>
          <Countdown targetDate={eventDate} />
          <div className="text-sm text-neutral-700">Équipes déjà inscrites : <strong>{totalRegistered}</strong></div>
          <button onClick={onInscrire} className="px-4 py-2 bg-neutral-900 text-white rounded hover:opacity-90 self-start">S'inscrire</button>
        </div>
      </div>

      {/* Sponsor principal */}
      <div className="mt-6 md:mt-10 bg-white border border-neutral-300 rounded-lg h-24 md:h-28 flex items-center justify-center">
        <span className="text-neutral-600">BANDEAU SPONSOR PRINCIPAL (logo)</span>
      </div>

      {/* Chiffres clés */}
      <div className="mt-6 grid sm:grid-cols-3 gap-4">
        <StatCard label="Catégories" value="6" />
        <StatCard label="Équipes" value="180" />
        <StatCard label="Enfants" value="900" />
      </div>

      <div className="mt-4 bg-white border border-neutral-300 rounded-lg p-4 text-sm text-neutral-700">
        <p className="mb-3">
          Tournoi de football junior. Inscriptions ouvertes aux clubs de la région. 30 équipes max par catégorie. Jusqu'à 2 équipes par club et par catégorie.
        </p>
        <div className="flex gap-3">
          <button onClick={onInscrire} className="px-4 py-2 bg-neutral-900 text-white rounded hover:opacity-90">Inscription</button>
          <a href="#" onClick={(e) => e.preventDefault()} className="px-4 py-2 border border-neutral-400 rounded">Voir les catégories</a>
        </div>
      </div>
    </section>
  );
}

function Countdown({ targetDate }) {
  const [now, setNow] = useState(() => new Date());
  useEffect(() => {
    const id = setInterval(() => setNow(new Date()), 1000);
    return () => clearInterval(id);
  }, []);
  const t = new Date(targetDate).getTime() - now.getTime();
  const days = Math.max(0, Math.floor(t / (1000 * 60 * 60 * 24)));
  const hours = Math.max(0, Math.floor((t / (1000 * 60 * 60)) % 24));
  const minutes = Math.max(0, Math.floor((t / (1000 * 60)) % 60));
  const seconds = Math.max(0, Math.floor((t / 1000) % 60));
  return (
    <div className="grid grid-cols-4 gap-2 text-center">
      <TimeBox label="Jours" value={days} />
      <TimeBox label="Heures" value={hours} />
      <TimeBox label="Minutes" value={minutes} />
      <TimeBox label="Secondes" value={seconds} />
    </div>
  );
}

function TimeBox({ label, value }) {
  return (
    <div className="border border-neutral-300 rounded p-2">
      <div className="text-xl font-semibold">{value}</div>
      <div className="text-xs text-neutral-600">{label}</div>
    </div>
  );
}

function StatCard({ label, value }) {
  return (
    <div className="bg-white border border-neutral-300 rounded-lg p-4 text-center">
      <div className="text-2xl font-semibold">{value}</div>
      <div className="text-sm text-neutral-600">{label}</div>
    </div>
  );
}

function Categories({ slotsLeft, selection, onChangeSelection, onNext, onBack }) {
  return (
    <section className="bg-white border border-neutral-300 rounded-lg p-4">
      <div className="flex items-center justify-between mb-4">
        <h2 className="text-xl font-semibold">Choisir les catégories & nombre d'équipes</h2>
        <button onClick={onBack} className="text-sm underline">← Retour</button>
      </div>

      <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {CATEGORIES.map((cat) => (
          <div key={cat.id} className="border border-neutral-300 rounded-lg p-4 flex flex-col gap-3">
            <div className="flex items-center justify-between">
              <div className="font-medium">Catégorie {cat.label}</div>
              <div className="text-xs text-neutral-600">Places restantes : {slotsLeft[cat.id]}</div>
            </div>
            <label className="text-sm">Nombre d'équipes (0–2)</label>
            <input
              type="number"
              min={0}
              max={2}
              value={selection[cat.id] || 0}
              onChange={(e) => onChangeSelection(cat.id, e.target.value)}
              className="border border-neutral-400 rounded p-2 w-24"
            />
            <div className="text-xs text-neutral-600">Max 2 équipes par club et par catégorie.</div>
          </div>
        ))}
      </div>

      <div className="mt-6 flex items-center justify-end gap-3">
        <button onClick={onBack} className="px-4 py-2 border border-neutral-400 rounded">Annuler</button>
        <button onClick={onNext} className="px-4 py-2 bg-neutral-900 text-white rounded">Continuer</button>
      </div>
    </section>
  );
}

function Deposant({ data, onChange, onNext, onBack }) {
  const set = (k, v) => onChange({ ...data, [k]: v });
  return (
    <section className="bg-white border border-neutral-300 rounded-lg p-4">
      <div className="flex items-center justify-between mb-4">
        <h2 className="text-xl font-semibold">Informations du déposant</h2>
        <button onClick={onBack} className="text-sm underline">← Retour</button>
      </div>

      <div className="grid sm:grid-cols-2 gap-4">
        <Field label="Prénom"><input className="w-full border border-neutral-400 rounded p-2" value={data.prenom} onChange={(e) => set("prenom", e.target.value)} /></Field>
        <Field label="Nom"><input className="w-full border border-neutral-400 rounded p-2" value={data.nom} onChange={(e) => set("nom", e.target.value)} /></Field>
        <Field label="E‑mail"><input className="w-full border border-neutral-400 rounded p-2" type="email" value={data.email} onChange={(e) => set("email", e.target.value)} /></Field>
        <Field label="Téléphone"><input className="w-full border border-neutral-400 rounded p-2" value={data.telephone} onChange={(e) => set("telephone", e.target.value)} /></Field>
        <Field label="Club (inscription pour l'occasion)"><input className="w-full border border-neutral-400 rounded p-2" value={data.club} onChange={(e) => set("club", e.target.value)} /></Field>
      </div>

      <div className="mt-6 flex items-center justify-end gap-3">
        <button onClick={onBack} className="px-4 py-2 border border-neutral-400 rounded">Retour</button>
        <button onClick={onNext} className="px-4 py-2 bg-neutral-900 text-white rounded">Continuer</button>
      </div>
    </section>
  );
}

function Teams({ teams, onChangeTeam, onNext, onBack }) {
  return (
    <section className="bg-white border border-neutral-300 rounded-lg p-4">
      <div className="flex items-center justify-between mb-4">
        <h2 className="text-xl font-semibold">Responsables d'équipe</h2>
        <button onClick={onBack} className="text-sm underline">← Retour</button>
      </div>

      {teams.length === 0 && <div className="text-sm text-neutral-600">Aucune équipe sélectionnée.</div>}

      <div className="grid gap-4">
        {teams.map((t, i) => (
          <div key={i} className="border border-neutral-300 rounded p-4">
            <div className="text-sm mb-3">Catégorie <strong>{t.category}</strong> – Équipe {t.idx}</div>
            <div className="grid sm:grid-cols-2 gap-4">
              <Field label="Nom de l’équipe">
                <input className="w-full border border-neutral-400 rounded p-2" value={t.nomEquipe || ""} onChange={(e) => onChangeTeam(i, { ...t, nomEquipe: e.target.value })} />
              </Field>
            </div>
            <div className="grid sm:grid-cols-2 gap-4 mt-3">
              <Field label="Prénom"><input className="w-full border border-neutral-400 rounded p-2" value={t.prenom} onChange={(e) => onChangeTeam(i, { ...t, prenom: e.target.value })} /></Field>
              <Field label="Nom"><input className="w-full border border-neutral-400 rounded p-2" value={t.nom} onChange={(e) => onChangeTeam(i, { ...t, nom: e.target.value })} /></Field>
              <Field label="Téléphone"><input className="w-full border border-neutral-400 rounded p-2" value={t.telephone} onChange={(e) => onChangeTeam(i, { ...t, telephone: e.target.value })} /></Field>
              <Field label="E‑mail"><input className="w-full border border-neutral-400 rounded p-2" type="email" value={t.email} onChange={(e) => onChangeTeam(i, { ...t, email: e.target.value })} /></Field>
            </div>
          </div>
        ))}
      </div>

      <div className="mt-6 flex items-center justify-end gap-3">
        <button onClick={onBack} className="px-4 py-2 border border-neutral-400 rounded">Retour</button>
        <button onClick={onNext} className="px-4 py-2 bg-neutral-900 text-white rounded">Récapitulatif</button>
      </div>
    </section>
  );
}

function Field({ label, children }) {
  return (
    <label className="text-sm">
      <div className="mb-1 text-neutral-700">{label}</div>
      {children}
    </label>
  );
}

function Recap({ deposant, teams, selection, slotsLeft, onBack, onPay }) {
  const total = teams.length; // placeholder montant
  return (
    <section className="bg-white border border-neutral-300 rounded-lg p-4">
      <div className="flex items-center justify-between mb-4">
        <h2 className="text-xl font-semibold">Récapitulatif</h2>
        <button onClick={onBack} className="text-sm underline">← Modifier</button>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div>
          <h3 className="font-medium mb-2">Déposant</h3>
          <ul className="text-sm text-neutral-700 space-y-1">
            <li>{deposant.prenom} {deposant.nom}</li>
            <li>{deposant.email} • {deposant.telephone}</li>
            <li>Club : {deposant.club}</li>
          </ul>
        </div>
        <div>
          <h3 className="font-medium mb-2">Catégories & équipes</h3>
          <ul className="text-sm text-neutral-700 space-y-1">
            {Object.entries(selection).filter(([_, n]) => n > 0).map(([cat, n]) => (
              <li key={cat}>Catégorie {cat} : {n} équipe(s) (restant: {slotsLeft[cat]})</li>
            ))}
          </ul>
        </div>
      </div>

      <div className="mt-6">
        <h3 className="font-medium mb-2">Responsables d'équipe</h3>
        <div className="grid gap-2 text-sm">
          {teams.map((t, i) => (
            <div key={i} className="border border-dashed border-neutral-400 rounded p-3">
              <div className="text-neutral-800">
                {t.prenom} {t.nom} – {t.email} – {t.telephone}{" "}
                <span className="text-neutral-500">(Cat. {t.category}, Équipe {t.idx}{t.nomEquipe ? ' – "' + t.nomEquipe + '"' : ''})</span>
              </div>
            </div>
          ))}
        </div>
      </div>

      <div className="mt-6 flex items-center justify-between">
        <div className="text-sm text-neutral-700">Total équipes : <strong>{total}</strong> — Montant : <span className="italic">CHF XXX.-</span></div>
        <div className="flex gap-3">
          <button onClick={onBack} className="px-4 py-2 border border-neutral-400 rounded">Retour</button>
          <button onClick={onPay} className="px-4 py-2 bg-neutral-900 text-white rounded">Procéder au paiement</button>
        </div>
      </div>
    </section>
  );
}

function Paiement({ totalTeams, onBack, onPaid }) {
  return (
    <section className="bg-white border border-neutral-300 rounded-lg p-4">
      <div className="flex items-center justify-between mb-4">
        <h2 className="text-xl font-semibold">Paiement</h2>
        <button onClick={onBack} className="text-sm underline">← Récapitulatif</button>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="border border-neutral-300 rounded p-4">
          <div className="text-sm text-neutral-700 mb-2">Total équipes : {totalTeams}</div>
          <div className="text-sm text-neutral-700 mb-4">Montant total : <span className="italic">CHF XXX.-</span></div>
          <div className="text-xs text-neutral-600">(Le tarif exact sera défini côté orga / WordPress)</div>
        </div>
        <div className="border border-neutral-300 rounded p-4 space-y-3">
          <button className="w-full py-2 bg-neutral-900 text-white rounded" onClick={onPaid}>Payer par carte (wireframe)</button>
          <button className="w-full py-2 border border-neutral-400 rounded" onClick={onPaid}>Payer avec TWINT (wireframe)</button>
        </div>
      </div>

      <div className="mt-6 text-xs text-neutral-600">Astuce WordPress : Stripe (CB) + TWINT via plugin (p.ex. Payrexx, TWINT for WooCommerce) — redirection post‑paiement vers /confirmation + webhooks pour e‑mails.</div>
    </section>
  );
}

function Confirmation({ deposant, teams, onNouveau }) {
  const [showEmails, setShowEmails] = useState(false);
  return (
    <section className="bg-white border border-neutral-300 rounded-lg p-4">
      <h2 className="text-xl font-semibold mb-2">Confirmation</h2>
      <p className="text-sm text-neutral-700">Merci ! Votre inscription est confirmée. Un e‑mail de quittance a été envoyé au déposant.</p>

      <div className="mt-4 flex gap-3">
        <button onClick={() => setShowEmails(true)} className="px-4 py-2 border border-neutral-400 rounded">Aperçu des e‑mails</button>
        <button onClick={onNouveau} className="px-4 py-2 bg-neutral-900 text-white rounded">Nouvelle inscription</button>
      </div>

      {showEmails && (
        <div className="mt-6 grid md:grid-cols-2 gap-4">
          <div className="border border-neutral-300 rounded p-4">
            <h3 className="font-medium mb-2">E‑mail au déposant (avec quittance)</h3>
            <p className="text-xs text-neutral-700">
              Objet : Confirmation d'inscription – Tournoi Régional<br />
              Bonjour {deposant.prenom} {deposant.nom},<br />
              Nous confirmons l’inscription de <strong>{teams.length}</strong> équipe(s) pour le club <strong>{deposant.club}</strong>.
              Vous trouverez la quittance en pièce jointe. Merci et à bientôt !
            </p>
          </div>
          <div className="border border-neutral-300 rounded p-4">
            <h3 className="font-medium mb-2">E‑mail au responsable d’équipe (sans quittance)</h3>
            <p className="text-xs text-neutral-700">
              Objet : Vous êtes responsable d'équipe – Tournoi Régional<br />
              Bonjour [Prénom Nom],<br />
              Vous avez été désigné(e) responsable de l’équipe [Catégorie + n°][ – "Nom d'équipe" si fourni]. Merci de rester joignable avant et pendant l’événement.
            </p>
          </div>
        </div>
      )}
    </section>
  );
}

function Footer() {
  return (
    <footer className="mt-12 border-t border-neutral-300 bg-white">
      <div className="max-w-6xl mx-auto p-6 grid md:grid-cols-4 gap-6 text-sm text-neutral-700">
        <div>
          <div className="font-semibold mb-2">Tournoi Régional</div>
          <p>Tournoi junior – clubs de la région. 30 équipes par catégorie, 6 catégories.</p>
        </div>
        <div>
          <div className="font-semibold mb-2">Contact</div>
          <ul className="space-y-1">
            <li>Email : contact@tournoi.ch</li>
            <li>Tél : +41 79 000 00 00</li>
            <li>Adresse : Rue du Stade 1, 1950 Sion</li>
          </ul>
        </div>
        <div>
          <div className="font-semibold mb-2">Liens</div>
          <ul className="space-y-1">
            <li><a href="#" onClick={(e) => e.preventDefault()} className="underline">Règlement</a></li>
            <li><a href="#" onClick={(e) => e.preventDefault()} className="underline">FAQ</a></li>
            <li><a href="#" onClick={(e) => e.preventDefault()} className="underline">Mentions & RGPD</a></li>
          </ul>
        </div>
        <div>
          <div className="font-semibold mb-2">Sponsors</div>
          <div className="h-16 border border-neutral-300 rounded flex items-center justify-center">LOGOS</div>
        </div>
      </div>
      <div className="border-t border-neutral-200">
        <div className="max-w-6xl mx-auto p-4 text-xs text-neutral-600 flex items-center justify-between">
          <div>© {new Date().getFullYear()} Tournoi Régional</div>
          <div className="flex gap-3">
            <a href="#" onClick={(e) => e.preventDefault()} className="underline">Contact</a>
            <a href="#" onClick={(e) => e.preventDefault()} className="underline">Partenaires</a>
          </div>
        </div>
      </div>
    </footer>
  );
}
